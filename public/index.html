<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Invitación interactiva — [EMPRESA]</title>
  <!-- Tailwind CDN (rápido para prototipo) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Pequeñas mejoras visuales */
    body{background:linear-gradient(180deg,#f8fafc,#ffffff);}
    .card{backdrop-filter: blur(4px);} 



.boton-ubicacion {
  display: inline-block;
  margin-top: 20px;
  background: #b4b4b4;
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: bold;
}
.boton-ubicacion:hover {
  background: #ffffff;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
.float {
  animation: float 4s ease-in-out infinite;
}




  </style>
</head>

<body class="h-screen w-screen bg-gradient-to-b from-sky-100 to-white flex items-center justify-center p-0 m-0">
  <main class="h-full w-full bg-white/70 border border-slate-200 rounded-none shadow-inner p-6 overflow-auto card ">
    <!-- Header: logo y título -->
<!-- Encabezado decorativo -->
<header class="relative w-full h-72 h-screen bg-gradient-to-b from-black to-[#0d2755] overflow-hidden flex justify-center items-center">
  <!-- Imágenes decorativas flotantes -->
  <img src="https://img.icons8.com/fluency/48/snow-storm.png" alt="Adorno navideño" class="absolute top-6 left-10 w-24 drop-shadow-lg float">

  <img src="https://img.icons8.com/fluency/96/sparkling.png" alt="Regalo navideño" class="absolute top-10 right-12 w-28 opacity-90 float">

  <img src="https://img.icons8.com/fluency/48/christmas-candle.png" alt="Bastón dulce" class="absolute bottom-8 left-1/4 w-20 opacity-80 float">

  <img src="https://img.icons8.com/fluency/96/sparkling.png
    " alt="Campana" class="absolute top-16 left-1/2 w-24 -translate-x-1/2 float">

  <img src="https://img.icons8.com/fluency/96/candy-cane--v1.png" alt="Copo de nieve" class="absolute bottom-10 right-1/4 w-20 float">

  <!-- Texto o logo central -->
  <div class="relative z-10 text-center">
    <h1 class="text-4xl font-bold text-red-700 drop-shadow-sm">✨ Invitación Especial ✨</h1>
    <p class="text-green-700 mt-2 text-lg">Acompáñanos a celebrar esta Navidad</p>
  </div>
</header>


    <!-- Area de video -->
    <section class="mb-4">
      <!-- Puede ser iframe (YouTube) o un <video> local/mp4 -->

        <div class="aspect-video bg-black rounded overflow-hidden relative">
    <video id="inviteVideo"
           class="w-full h-full object-cover"
           autoplay
           muted
           playsinline
           preload="auto">
      <source src="video.mp4" type="video/mp4">
      Tu navegador no soporta la etiqueta <code>video</code>.
    </video>
      </div>
    </section>

    <!-- Botones de respuesta -->
    <section class="mb-4 flex flex-col gap-3">
      <div class="flex gap-3">
        <button id="confirmBtn" class="flex-1 py-3 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700">✅ Confirmar asistencia</button>
        <button id="declineBtn" class="flex-1 py-3 rounded-lg bg-red-500 text-white font-medium hover:bg-red-600">❌ No podré asistir</button>
      </div>

      <!-- Panel de confirmación: aparición modal / inline -->
      <div id="confirmPanel" class="hidden p-4 border rounded bg-green-50">
        <label class="block text-sm font-medium mb-2">Confirma tu asistencia (personalizado para <span id="guestNameSpan">invitado</span>)</label>
        <div class="flex gap-2 items-center mb-2">
          <input id="attendeesInput" type="number" min="1" value="1" class="w-24 p-2 border rounded" />
          <span class="text-sm text-slate-600">personas</span><button id="confirmLocalBtn" class="px-4 py-2 rounded border">Confirmar aquí (guardar)</button>
        </div>
        <div class="flex gap-2">
          <button id="sendWhatsappBtn" class="px-4 py-2 rounded bg-sky-600 text-white">Enviar por WhatsApp</button>
          
        </div>
        <p id="confirmNote" class="text-xs text-slate-500 mt-2">Nota: Para que el recuento sea definitivo, el robot de WhatsApp procesará cada confirmación y la mostrará en el resumen de la anfitriona. Este prototipo guarda una versión local como respaldo.</p>
      </div>

      <!-- Mensaje cuando declina -->
      <div id="declinePanel" class="hidden p-4 border rounded bg-red-50">
        <p class="text-sm">Lamentamos que no puedas asistir. ¿Quieres enviar una nota a la anfitriona?</p>
        <div class="mt-2 flex gap-2">
          <button id="sendDeclineWhatsappBtn" class="px-4 py-2 rounded bg-sky-600 text-white">Enviar nota por WhatsApp</button>
          <button id="declineLocalBtn" class="px-4 py-2 rounded border">Registrar aquí</button>
        </div>
      </div>
    </section>

    <!-- Ubicación -->
    <section class="mb-4">
      <h3 class="font-medium">Ubicación</h3>
      <p class="text-sm text-slate-600">Dirección: <a id="mapsLink" href="https://www.google.com/maps/place/Virgen+de+las+Virtudes+Pte.,+La+Guadalupana,+55060+Ecatepec+de+Morelos,+Méx./@19.6204402,-99.0135958,17z/data=!3m1!4b1!4m6!3m5!1s0x85d1f1fdebe8cc85:0xee5650664b67c6d!8m2!3d19.6204402!4d-99.0135958!16s%2Fg%2F11h5r_475k!17m2!4m1!1e3!18m1!1e1?entry=ttu&g_ep=EgoyMDI1MTEwOS4wIKXMDSoASAFQAw%3D%3D" target="_blank" class="text-sky-600 boton-ubicacion underline">Abrir en Maps</a></p>
    </section>

    <!-- Resumen visible (opcional) -->
    <section class="text-sm text-slate-700 border-t pt-3">
      <p>Estado de tu respuesta: <strong id="statusText">No respondiste</strong></p>
      <p class="mt-2 text-xs text-slate-500">Este demo usa <code>localStorage</code> para evitar duplicados en el mismo navegador y muestra cómo integrarlo con un backend real para idempotencia y reportes semanales.</p>
    </section>
  </main>

  <script>
    /* ---------- CONFIG (Reemplazar en producción) ---------- */
    const CONFIG = {
      BOT_WHATSAPP_NUMBER: '5212345678900', // formato internacional sin + (ejemplo: 521234...)
      HOST_PHONE_FOR_REPORTS: '5210987654321', // número de la anfitriona (para notificaciones), si se usa API
      API_BASE: '/api', // endpoint servidor para confirmaciones definitivas
      WEEKLY_REPORT_SUBSCRIBE_ENDPOINT: '/api/subscribe-weekly-report'
    };

    /* ---------- UTIL: lectura de parámetros URL para personalizar invitado ---------- */
    function getQueryParams() {
      const p = {};
      location.search.replace(/^[?]/,'').split('&').forEach(pair => {
        if(!pair) return;
        const [k,v] = pair.split('=').map(decodeURIComponent);
        p[k] = v;
      });
      return p;
    }

    const params = getQueryParams();
    const guestName = params.guest || params.nombre || 'Invitado';
    const token = params.token || null; // token único para identificar al usuario (recomendado)

    // Rellenar UI
    document.getElementById('guestNameSpan').textContent = guestName;

    // Maps: aceptar lat/lng o dirección
    const maps = params.maps || 'Virgen de las Virtudes Pte., La Guadalupana, 55060 Ecatepec de Morelos, Méx.';
    document.getElementById('mapsLink').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(maps)}`;

    /* ---------- Control de estado local para evitar duplicados en este navegador ---------- */
    const storageKey = `invite_confirm_${token||guestName}`;
    function loadLocalState(){
      try { return JSON.parse(localStorage.getItem(storageKey)) || {status:'none',attendees:0}; } catch(e){return {status:'none',attendees:0};}
    }
    function saveLocalState(s){ localStorage.setItem(storageKey, JSON.stringify(s)); }

    const state = loadLocalState();
    const statusText = document.getElementById('statusText');
    function refreshStatus(){
      if(state.status==='confirmed') statusText.textContent = `Confirmado — ${state.attendees} persona(s)`;
      else if(state.status==='declined') statusText.textContent = 'Declinaste la invitación';
      else statusText.textContent = 'No respondiste';
    }
    refreshStatus();

    /* ---------- Botones y comportamientos ---------- */
    const confirmBtn = document.getElementById('confirmBtn');
    const declineBtn = document.getElementById('declineBtn');
    const confirmPanel = document.getElementById('confirmPanel');
    const declinePanel = document.getElementById('declinePanel');
    const attendeesInput = document.getElementById('attendeesInput');
    const sendWhatsappBtn = document.getElementById('sendWhatsappBtn');
    const confirmLocalBtn = document.getElementById('confirmLocalBtn');
    const sendDeclineWhatsappBtn = document.getElementById('sendDeclineWhatsappBtn');
    const declineLocalBtn = document.getElementById('declineLocalBtn');

    confirmBtn.addEventListener('click', ()=>{
      confirmPanel.classList.toggle('hidden');
      declinePanel.classList.add('hidden');
    });
    declineBtn.addEventListener('click', ()=>{
      declinePanel.classList.toggle('hidden');
      confirmPanel.classList.add('hidden');
    });

    /* Enviar pre-mensaje a WhatsApp (abre chat en web/cliente con mensaje prellenado) */
    function makeWhatsAppUrl(number, text){
      const base = `https://wa.me/${number}`;
      return `${base}?text=${encodeURIComponent(text)}`;
    }

    sendWhatsappBtn.addEventListener('click', ()=>{
      const attendees = Math.max(1, parseInt(attendeesInput.value||1));
      // Mensaje estructurado que el bot debería saber interpretar
      const msg = `CONFIRMACION|guest:${guestName}|token:${token||'none'}|attendees:${attendees}|event:[EVENT_ID]`;
      const url = makeWhatsAppUrl(CONFIG.BOT_WHATSAPP_NUMBER, msg);
      // Abrir WhatsApp (el usuario debe enviar el mensaje). En producción se recomienda un backend que use la API para enviar/recibir.
      window.open(url, '_blank');
      // Guardar pre-estado localmente (evitar re-envíos desde mismo navegador)
      state.status = 'pending_whatsapp'; state.attendees = attendees; saveLocalState(state); refreshStatus();
    });

    /* Confirmar localmente (usado como respaldo si no se completa por WhatsApp) */
    confirmLocalBtn.addEventListener('click', async ()=>{
      const attendees = Math.max(1, parseInt(attendeesInput.value||1));
      // Actualización local inmediata
      state.status = 'confirmed'; state.attendees = attendees; saveLocalState(state); refreshStatus();

      // Intentar notificar al backend (si existe)
      try{
        await fetch(CONFIG.API_BASE+"/confirm",{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({guest:guestName, token, attendees, source:'web'})
        });
      }catch(e){ console.warn('No se pudo notificar al backend:',e); }

      alert('Gracias — tu confirmación quedó registrada (local). En producción el robot de WhatsApp también la procesará.');
    });

    /* Declinar: enviar WhatsApp o guardar local */
    sendDeclineWhatsappBtn.addEventListener('click', ()=>{
      const msg = `DECLINO|guest:${guestName}|token:${token||'none'}|event:[EVENT_ID]`;
      window.open(makeWhatsAppUrl(CONFIG.BOT_WHATSAPP_NUMBER, msg), '_blank');
      state.status = 'declined'; state.attendees = 0; saveLocalState(state); refreshStatus();
    });
    declineLocalBtn.addEventListener('click', async ()=>{
      state.status = 'declined'; state.attendees = 0; saveLocalState(state); refreshStatus();
      try{
        await fetch(CONFIG.API_BASE+"/decline",{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({guest:guestName, token, source:'web'})});
      }catch(e){}
      alert('Se registró tu declinación (local).');
    });

    /* ---------- Suscripción al reporte semanal (opcional) ---------- */
    // Si el enlace token está presente, podemos (desde frontend) pedir suscripción al reporte semanal para la anfitriona.
    async function subscribeWeeklyReport(){
      try{
        await fetch(CONFIG.WEEKLY_REPORT_SUBSCRIBE_ENDPOINT, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({eventId:'[EVENT_ID]', hostPhone:CONFIG.HOST_PHONE_FOR_REPORTS})});
      }catch(e){/* no crítico */}
    }
    // subscribeWeeklyReport(); // descomentar si ya tienes backend

    /* ---------- Advertencias y notas de seguridad / integridad ---------- */
    /*
      IMPORTANTE: este prototipo incorpora medidas CLIENT-SIDE (localStorage + token en URL) para evitar
      que la misma persona confirme varias veces desde el MISMO dispositivo/ navegador. Esto NO evita
      fraude si alguien confirma desde distintos dispositivos o intenta manipular el conteo.

      Recomendación de producción (resumen):
        1) Generar un token único por invitado y tramar URLs personalizadas: ?token=abc123&guest=Nombre
        2) Implementar un backend (Node.js / Express) con base de datos (Postgres, MySQL o Firestore)
           que registre cada confirmación con marca de tiempo y token.
        3) Cuando el BOT de WhatsApp reciba un mensaje, validar el token contra la base de datos y
           solo aceptar la confirmación si el token no ha sido usada o si la nueva confirmación es una
           actualización legítima (ej. reducir asistentes) según reglas de negocio.
        4) Emplear idempotencia: confirmar por token — si ya existe, actualizar en lugar de sumar doble.
        5) Para enviar mensajes automáticos (bot), usar Twilio API o la API oficial de WhatsApp Business
           en el backend para no depender de que el usuario pulse enviar en su app.
        6) Generar reportes semanales con un cron job (ej. cron en Node, Google Cloud Scheduler, o AWS CloudWatch Events)
           que compile conteos y envíe a la anfitriona (WhatsApp/Email).
    */

  </script>
</body>
</html>
